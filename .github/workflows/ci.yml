name: Build & Release

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - "v*"
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"

jobs:
  test:
    name: Test (fmt/clippy/tests)
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Check formatting
        run: cargo fmt -- --check

      - name: Run clippy
        run: cargo clippy -- -D warnings

      - name: Run tests
        run: cargo test --locked --verbose

  package-linux:
    name: Package (Linux .deb + .rpm)
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Validate tag matches Cargo.toml version
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          set -euo pipefail
          tag="${GITHUB_REF_NAME#v}"
          cargo_version="$(grep -m 1 '^version = ' Cargo.toml | cut -d '"' -f 2)"
          if [ "$tag" != "$cargo_version" ]; then
            echo "ERROR: tag version ($tag) != Cargo.toml version ($cargo_version)" >&2
            exit 1
          fi

      - name: System deps (common for openssl-sys)
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Install packagers
        run: cargo install cargo-deb cargo-generate-rpm --locked

      - name: Build release
        run: cargo build --release --locked

      - name: Build Debian package (.deb)
        run: cargo deb --no-build --locked

      - name: Build Fedora/RHEL package (.rpm)
        run: cargo generate-rpm

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          # Binary
          cp target/release/cbrec dist/cbrec-linux-x86_64

          # Deb (cargo-deb usually writes into target/**/debian/*.deb)
          deb="$(find target -type f -path '*/debian/*.deb' -print -quit)"
          test -n "${deb:-}"
          cp "$deb" dist/cbrec-linux-x86_64.deb

          # Rpm (cargo-generate-rpm writes into target/generate-rpm/*.rpm)
          rpm="$(find target/generate-rpm -maxdepth 1 -type f -name '*.rpm' -print -quit)"
          test -n "${rpm:-}"
          cp "$rpm" dist/cbrec-linux-x86_64.rpm

          ls -la dist

      - name: Upload artifacts (Linux)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: cbrec-linux-x86_64
          path: dist/*
          if-no-files-found: error
          retention-days: 14

  package-windows:
    name: Package (Windows .msi)
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    needs: test
    runs-on: windows-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561
        with:
          toolchain: stable

      - name: Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Validate tag matches Cargo.toml version
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          $tag = "${env:GITHUB_REF_NAME}".TrimStart("v")
          $cargoVersion = (Select-String -Path "Cargo.toml" -Pattern '^version\s*=\s*"' | Select-Object -First 1).Line.Split('"')[1]
          if ($tag -ne $cargoVersion) {
            throw "ERROR: tag version ($tag) != Cargo.toml version ($cargoVersion)"
          }

      - name: Install WiX Toolset (via Chocolatey)
        shell: pwsh
        run: |
          choco install wixtoolset -y --no-progress

      - name: Install cargo-wix
        shell: pwsh
        run: |
          cargo install cargo-wix --locked

      - name: Build release
        shell: pwsh
        run: |
          cargo build --release --locked

      - name: Build MSI (cargo wix)
        shell: pwsh
        run: |
          # Create wix/main.wxs if it doesn't exist
          if (-not (Test-Path "wix\main.wxs")) {
            cargo wix init
          }

          cargo wix

          New-Item -ItemType Directory -Force -Path dist | Out-Null

          Copy-Item "target\release\cbrec.exe" "dist\cbrec-windows-x86_64.exe"

          $msi = Get-ChildItem -Path "target\wix" -Filter "*.msi" | Select-Object -First 1
          if (-not $msi) { throw "MSI not found in target\wix" }

          Copy-Item $msi.FullName "dist\cbrec-windows-x86_64.msi"
          Get-ChildItem dist

      - name: Upload artifacts (Windows)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: cbrec-windows-x86_64
          path: dist/*
          if-no-files-found: error
          retention-days: 14

  release:
    name: Release (assets + SHA256SUMS)
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [package-linux, package-windows]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Download all artifacts into dist/
        uses: actions/download-artifact@v5
        with:
          path: dist
          merge-multiple: true

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          # stable order
          find . -maxdepth 1 -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS
          echo "---- SHA256SUMS ----"
          cat SHA256SUMS

      - name: Create release notes
        env:
          VERSION: ${{ github.ref_name }}
        shell: bash
          run: |
            cat > release_notes.md <<EOF
            Release ${VERSION}

          Archivos:
          - cbrec-linux-x86_64.deb
          - cbrec-linux-x86_64.rpm
          - cbrec-windows-x86_64.msi
          - SHA256SUMS

          Verificación (Linux):
            sha256sum -c SHA256SUMS

          Verificación (Windows PowerShell):
            Get-FileHash .\cbrec-windows-x86_64.msi -Algorithm SHA256
            EOF

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          tag_name: ${{ github.ref_name }}
          name: cbrec ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            dist/*
          fail_on_unmatched_files: true
